{% extends 'ligameet/base.html' %}
{% load static %}


{% block content %}
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #1c1c1c;
    color: #fff;
    margin: 0;
    padding: 0;
}

.container {
    display: flex;
}

.events-section {
    flex: 2;
    padding: 20px;
}

.recent-activity-section {
    flex: 1;
    background-color: #f7f8fc;
    padding: 20px;
    color: black;
}

.search-bar input {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: none;
}

.event-list {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 20px;
}

.event-card, .activity-card {
    background-color: black;
    padding: 20px;
    border-radius: 10px;
}

.create-event-btn {
    display: block;
    width: 100%;
    padding: 10px;
    background-color: #0d6efd;
    color: white;
    border: none;
    border-radius: 5px;
    margin-bottom: 20px;
}

h2 {
    margin-top: 0;
}
</style>
<div class="container">
  <!-- Left Section: Events -->
  <div class="events-section">
      <div class="search-bar">
          <input type="text" placeholder="Search Event">
      </div>
      
      <div class="ongoing-events">
          <h2>Ongoing Events</h2>
          <div class="event-list">
              {% for event in ongoing_events %}
              <div class="event-card">
                  <h3>{{ event.EVENT_NAME }}</h3>
                  <p>{{ event.EVENT_LOCATION }}</p>
                  <p>{{ event.EVENT_DATE_START|date:"M d, Y" }} - {{ event.EVENT_DATE_END|date:"M d, Y" }}</p>
              </div>
              {% empty %}
              <p>No ongoing events.</p>
              {% endfor %}
          </div>
      </div>
      
      <div class="upcoming-events">
          <h2>Upcoming Events</h2>
          <div class="event-list">
              {% for event in upcoming_events %}
              <div class="event-card">
                  <h3>{{ event.EVENT_NAME }}</h3>
                  <p>{{ event.EVENT_LOCATION }}</p>
                  <p>{{ event.EVENT_DATE_START|date:"M d, Y" }} - {{ event.EVENT_DATE_END|date:"M d, Y" }}</p>
              </div>
              {% empty %}
              <p>No upcoming events.</p>
              {% endfor %}
          </div>
      </div>
  </div>

  <!-- Right Section: Recent Activity -->
  <div class="recent-activity-section">
    <button class="create-event-btn btn btn-primary" data-bs-toggle="modal" data-bs-target="#sportModal">
      Create Event
  </button>
    <h2>Recent Activity</h2>
    <div class="activity-list">
        {% for activity in recent_activity %}
        <div class="activity-card" style="color:white">
            <p>{{ activity.EVENT_NAME }}</p>
            <span>{{ activity.EVENT_DATE_START|date:"M d, Y" }} - {{ activity.EVENT_DATE_END|date:"M d, Y" }}</span>
        </div>
        <br>
        {% empty %}
        <p>No recent activity.</p>
        {% endfor %}
    </div>
  </div>
</div>


<!-- View Events Modal -->
<div class="modal fade" id="ViewEventsModal" tabindex="-1" aria-labelledby="ViewEventsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg custom-modal">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="ViewEventsModallLabel">View Events</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
          </div>
          <div class="modal-body">
              <table class="table">
                  <thead>
                      <tr>
                          <th>Event Name</th>
                          <th>Sport</th>
                          <th>Date Start</th>
                          <th>Date End</th>
                          <th>Location</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for event in my_events %}
                          <tr>
                              <td>{{ event.EVENT_NAME }}</td>
                              <td>{{ event.SPORT_ID.SPORT_NAME }}</td>
                              <td>{{ event.EVENT_DATE_START }}</td>
                              <td>{{ event.EVENT_DATE_END }}</td>
                              <td>{{ event.EVENT_LOCATION }}</td>
                          </tr>
                      {% empty %}
                          <tr>
                              <td colspan="5">No events created by you.</td>
                          </tr>
                      {% endfor %}
                  </tbody>
              </table>
          </div>
      </div>
  </div>
</div>


<!-- Sport Modal -->
<div class="modal fade" id="sportModal" tabindex="-1" aria-labelledby="sportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="sportModalLabel">Choose Sport</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div class="d-flex justify-content-center">
                  <!-- Basketball Button -->
                  <button type="button" class="list-group-item list-group-item-action square-button mx-2"
                      style="background-image: url('/media/sports_icon/basketball.png'); background-size: cover; background-position: center; color:black; width: 150px; height: 150px;"
                      onclick="showEventModal('Basketball', 1)">
                      <span class="square-button-text">Basketball</span>
                  </button>

                  <!-- Volleyball Button -->
                  <button type="button" class="list-group-item list-group-item-action square-button mx-2"
                      style="background-image: url('/media/sports_icon/volleyball.png'); background-size: cover; background-position: center; color:black; width: 150px; height: 150px;"
                      onclick="showEventModal('Volleyball', 2)">
                      <span class="square-button-text">Volleyball</span>
                  </button>
              </div>
          </div>
      </div>
  </div>
</div>



<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg"> <!-- Changed size to large for two-column layout -->
  <div class="modal-content">
      <div class="modal-header">
          <h5 class="modal-title" id="eventModalLabel">Create Event/Tournament</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
      </div>
      <div class="modal-body">
          <div class="row">
              <!-- Left Column: Form Fields -->
              <div class="col-md-6">
                  <form id="eventForm"> <!-- TODO make a crispy forms.py to handle the error -->
                      <div class="mb-3">
                          <label for="sportInput" class="form-label">Sport</label>
                          <input type="text" class="form-control" id="sportInput" readonly>
                      </div>
                      <div class="mb-3">
                          <label for="eventName" class="form-label">Event Name</label>
                          <input type="text" class="form-control" id="eventName" required>
                      </div>
                      <div class="mb-3">
                          <label for="eventDateStart" class="form-label">Event Start Date</label>
                          <input type="datetime-local" class="form-control" id="eventDateStart" required>
                      </div>
                      <div class="mb-3">
                          <label for="eventDateEnd" class="form-label">Event End Date</label>
                          <input type="datetime-local" class="form-control" id="eventDateEnd" required disabled>
                      </div>
                      <div class="mb-3">
                          <label for="pac-input" class="form-label">Location</label>
                          <input type="text" class="form-control" id="eventLocation" placeholder="Search for a place">
                      </div>
                      <button type="submit" class="btn btn-primary">Create Event</button>
                  </form>
              </div>

              <!-- Right Column: Map -->
              <div class="col-md-6">
                  <div id="map" style="height: 400px; width: 100%;"></div>
              </div>
          </div>
      </div>
  </div>
</div>
</div>


<script async defer
src="https://maps.gomaps.pro/maps/api/js?key=AlzaSyzoe_vC-gxwKyAVXCJBJAweoTwy9szyTHW&libraries=geometry,places&callback=initMap">
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
function showEventModal(sport, sportId) {
  document.getElementById('sportInput').value = sport;
  document.getElementById('sportInput').setAttribute('data-sport-id', sportId); // Store sport ID
  var sportModal = bootstrap.Modal.getInstance(document.getElementById('sportModal'));
  sportModal.hide();
  var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
  eventModal.show();
}


// form submition 
document.getElementById('eventForm').addEventListener('submit', function(e) {
  e.preventDefault();

  var sport = document.getElementById('sportInput').value;
  var sportId = document.getElementById('sportInput').getAttribute('data-sport-id'); // Get sport ID
  var eventName = document.getElementById('eventName').value;
  var eventDateStart = document.getElementById('eventDateStart').value;
  var eventDateEnd = document.getElementById('eventDateEnd').value;
  var eventLocation = document.getElementById('eventLocation').value;

  fetch('/create-event/', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken'),
      },
      body: new URLSearchParams({
          'eventName': eventName,
          'eventDateStart': eventDateStart,
          'eventDateEnd': eventDateEnd,
          'eventLocation': eventLocation,
          'sportId': sportId // Send sport ID
      }),
  })
  .then(response => response.json())
  .then(data => {
      if (data.success) {
          alert(`Event ${data.event_name} created successfully!`);
          var eventModal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
          eventModal.hide();
      } else {
          alert('Error creating event: ' + data.error);
      }
  })
  .catch(error => console.error('Error:', error));
});

// token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Check if this cookie string begins with the name we want
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}



document.addEventListener("DOMContentLoaded", function() {
  // Get today's date in YYYY-MM-DD format
  const today = new Date();
  const dd = String(today.getDate()).padStart(2, '0');
  const mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
  const yyyy = today.getFullYear();
  const todayString = `${yyyy}-${mm}-${dd}`;

  // Set minimum date for start date input
  const eventDateStart = document.getElementById("eventDateStart");
  eventDateStart.setAttribute("min", todayString);

  // Disable earlier dates on load
  eventDateStart.value = todayString; // Set to today

  // Add event listener for start date change
  eventDateStart.addEventListener("change", function() {
      const startDateValue = new Date(this.value);
      const eventDateEnd = document.getElementById("eventDateEnd");

      // Check if selected date is before today
      if (startDateValue < today) {
          alert("The start date cannot be earlier than today.");
          this.value = todayString; // Reset to today's date
          return; // Exit if invalid
      }

      // Enable end date input if valid
      if (this.value) {
          eventDateEnd.disabled = false; // Enable end date input
          eventDateEnd.setAttribute("min", this.value); // Set minimum end date to start date

          // Clear the end date if it is invalid
          if (eventDateEnd.value && new Date(eventDateEnd.value) < startDateValue) {
              eventDateEnd.value = ""; // Clear invalid end date
          }
      } else {
          eventDateEnd.disabled = true; // Disable end date input if no start date is selected
      }
  });
});


let map;
let autocomplete;

function initMap() {
  // Create the map centered on a default location
  map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 10.3157, lng: 123.8854 }, // Cebu City, Philippines
      zoom: 13
  });

  const input = document.getElementById('eventLocation');

  // Create the autocomplete object and bind it to the input field
  autocomplete = new google.maps.places.Autocomplete(input);
  autocomplete.bindTo('bounds', map);

  // Set up the event listener for when the user selects a place
  autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) {
          console.log("No details available for the input: '" + place.name + "'");
          return;
      }

      if (place.geometry.viewport) {
          map.fitBounds(place.geometry.viewport);
      } else {
          map.setCenter(place.geometry.location);
          map.setZoom(17); // Zoom to 17 if the place has no viewport
      }

      // Place a marker on the selected location
      new google.maps.Marker({
          position: place.geometry.location,
          map: map
      });
  });
}
</script>
{% endblock %}